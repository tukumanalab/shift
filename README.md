# アルバイトシフト管理

Google OAuth認証とGoogle Sheets連携による高機能なシフト管理アプリケーションです。

## 概要

このアプリケーションは、アルバイトや小規模チームのシフト管理を効率化するWebアプリケーションです。Google のサービス群（Google Identity Services、Google Sheets、Google Apps Script、Google Calendar）を活用し、認証からデータ管理、カレンダー連携まで統合的にサポートします。

### 主な特徴

- **ゼロサーバー運用**: Google Apps Scriptによるサーバーレス構成
- **リアルタイム管理**: 即座に反映される空き枠と申請状況
- **直感的UI**: カレンダーベースの視覚的なシフト管理
- **権限ベースアクセス**: 一般ユーザー・管理者の役割分担
- **自動化**: カレンダー連携による手作業削減

## セットアップ手順

### 1. Google Cloud Consoleでの設定

1. [Google Cloud Console](https://console.cloud.google.com/)にアクセス
2. 新しいプロジェクトを作成または既存のプロジェクトを選択
3. 「APIとサービス」→「認証情報」に移動
4. 「認証情報を作成」→「OAuth 2.0 クライアントID」を選択
5. アプリケーションの種類で「ウェブアプリケーション」を選択
6. 承認済みのJavaScript生成元に以下を追加：
   - `http://localhost:8080`
   - `http://127.0.0.1:8080`
   - その他必要なドメイン
7. クライアントIDをコピー

### 2. アプリケーションの設定

1. `index.html`と`app.js`の`YOUR_GOOGLE_CLIENT_ID`を取得したクライアントIDに置き換え

### 3. アプリケーションの実行

ローカルサーバーを起動してテスト：

```bash
npm run dev
```

ブラウザで `http://localhost:8080` にアクセス

## 開発用コマンド

### Google Apps Script のデプロイ

Google Apps Script関連のファイルは `gas/` フォルダに整理されています。

#### デプロイ方法

Google Apps Scriptのデプロイは2段階の手順が必要です：

**1. コードのアップロード**
```bash
# NPMスクリプト（推奨）
npm run deploy:gas

# 直接実行
cd gas && ./deploy.sh
```

**2. 手動でのWebアプリデプロイ**

コードのアップロード後、以下の手順で手動デプロイを実行してください：

1. Google Apps Scriptエディタにアクセス：
   - プロジェクトURL: https://script.google.com/u/0/home/projects/1rABKUvGo1LK5Ob8A012r8iRi5SmvHWu7t2J1SbI7a3MhNZf9MA-AVve4/edit

2. デプロイの実行：
   - 右上の「デプロイ」ボタンをクリック
   - 「新しいデプロイ」を選択（初回の場合）
   - または「デプロイを管理」→「編集」→「バージョン: 新しいバージョン」を選択（既存デプロイの更新）

3. デプロイ設定：
   - 種類：「ウェブアプリ」を選択
   - 説明：変更内容を入力（任意）
   - 次のユーザーとして実行：「自分」
   - アクセスできるユーザー：「全員」
   - 「デプロイ」ボタンをクリック

4. 完了確認：
   - 新しいWebアプリURLが生成されます
   - このURLが実際のAPIエンドポイントとして使用されます

**注意**: `npm run deploy:gas`コマンドはコードをアップロードするだけです。Webアプリとして動作させるには、上記の手動デプロイが必須です。

#### 初回セットアップ
```bash
npm install -g @google/clasp
clasp login
```

詳細は `docs/clasp-setup.md` を参照してください。

#### ファイル構成
```
gas/
├── google-apps-script.js  # メインスクリプトファイル
├── config.js             # 設定ファイル（カレンダーID等）
├── .clasp.json           # clasp設定（gitignore済み）
├── appsscript.json       # Apps Script設定（gitignore済み）
└── .claspignore          # clasp無視ファイル
```

#### 設定変更
Google Apps Scriptの設定は `gas/config.js` で変更できます：
- `CALENDAR_ID`: GoogleカレンダーのカレンダーID
- `DEFAULT_CAPACITY`: 曜日別のデフォルト人数設定
- `SHEET_NAMES`: スプレッドシートのシート名

## 機能

### 認証・アクセス制御
- **Googleアカウントログイン**: Google Identity Services (GSI) による安全な認証
- **メールアドレス制限**: 指定されたメールアドレスのみアクセス可能
- **管理者権限**: 管理者ユーザーには追加機能を提供
- **ユーザープロフィール表示**: 名前、メール、プロフィール画像

### シフト管理システム
- **リアルタイム可用性表示**: 人数設定と現在の申請数に基づく残り枠表示
- **30分単位の時間枠**: 13:00-18:00の範囲で30分間隔の柔軟なシフト設定
- **重複申請防止**: 同一ユーザーが同じ日時に複数申請することを防止
- **シフトデータキャッシュ**: 初回読み込み後はキャッシュを使用してパフォーマンス向上

### ユーザー向け機能
- **シフト申請**: カレンダービューから直感的にシフト申請
- **自分のシフト一覧**: 申請済みシフトの確認と管理
- **日付詳細モーダル**: 各日付の詳細情報と申請可能枠を表示

### 管理者専用機能
- **全員のシフト一覧**: カレンダー形式で全スタッフのシフトを一覧表示
- **シフト詳細ダイアログ**: 日付クリックで詳細なシフト情報を表示
  - 時間帯ごとのグループ化表示
  - スタッフ名、メールアドレス、備考の詳細表示
  - 各時間帯の人数カウント表示
- **人数設定管理**: 日付・曜日別の必要人数設定
- **カレンダー連携**: 承認されたシフトをGoogleカレンダーに自動同期

### データ管理・バックエンド
- **Google Sheets統合**: データの永続化にGoogle Sheetsを使用
- **Google Apps Script API**: サーバーレスなバックエンド処理
- **RESTful API設計**: GET/POSTリクエストによるデータ操作
- **プロパティサービス**: 設定情報の安全な保存

### UI/UX機能
- **レスポンシブデザイン**: デスクトップとモバイルデバイス対応
- **ローディング表示**: データ読み込み中の視覚的フィードバック
- **エラーハンドリング**: 適切なエラーメッセージ表示
- **直感的なカレンダーUI**: 月単位表示と簡単な日付選択

## 使用技術

### フロントエンド
- **HTML5**: セマンティックなマークアップ
- **CSS3**: レスポンシブデザインとモダンなUI
- **Vanilla JavaScript**: フレームワークを使わない軽量な実装
- **Google Identity Services (GSI)**: OAuth2認証

### バックエンド・インフラ
- **Google Apps Script**: サーバーレスなバックエンド処理
- **Google Sheets**: データベースとしてのスプレッドシート活用
- **Google Calendar API**: シフトの自動カレンダー登録
- **Google Cloud Console**: OAuth設定とAPI管理

### 開発・デプロイツール
- **clasp**: Google Apps Scriptのローカル開発
- **npm**: パッケージ管理とスクリプト実行
- **http-server**: ローカル開発サーバー
- **Git**: バージョン管理

## 注意事項

### セキュリティ
- HTTPSまたはlocalhostでのみ動作します（Google OAuth要件）
- 認証されたメールアドレスのみアクセス可能
- 本番環境では適切なセキュリティ対策を実装してください

### 運用・制限事項
- Google Apps Scriptには実行時間制限があります（6分）
- Google Sheetsの行数制限（500万セル）にご注意ください
- OAuth設定とGoogle Apps Scriptデプロイの両方が必要です
- 開発サーバーは必ずポート8080で起動してください

### データバックアップ
- データはGoogle Sheetsに保存されるため、定期的なバックアップを推奨
- Googleアカウントの2段階認証を有効にすることを推奨